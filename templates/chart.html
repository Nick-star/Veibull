{% extends 'base.html' %}
{% block title %}График{% endblock %}
{% block content %}
    <div class="container">
        <div class="row">
            <div>
                <h1>Диаграмма срока службы электролизера</h1>
            </div>
        </div>
        <div class="row">
            <div class="col-md-3">
                <div class="form-group">
                    <label for="electrolyzer-type">Тип:</label>
                    <select id="electrolyzer-type" class="form-control">
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label for="building">Корпус:</label>
                    <select id="building" class="form-control">
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label for="start-date">Дата начала:</label>
                    <input type="date" id="start-date" class="form-control" value="2010-01-01">
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label for="end-date">Дата конца:</label>
                    <input type="date" id="end-date" class="form-control">
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label for="forecast-date">Дата прогноза:</label>
                    <input type="date" id="forecast-date" class="form-control">
                </div>
            </div>
            <div class="col-md-3 col-sm d-flex align-items-end">
                <button id="update-chart" class="btn btn-primary">Обновить</button>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <div id="chart"></div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <div class="table-responsive">
                    <table id="tableforecast" class="table table-striped table-bordered">
                        <thead>
                        <tr>
                            <th scope="col">Корпус</th>
                            <th scope="col">Тип</th>
                            <th scope="col">Даты</th>
                            <th scope="col">Всего действующих, шт</th>
                            <th scope="col">Дата прогноза</th>
                            <th scope="col">Прогноз отключений, шт</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td id="building1"></td>
                            <td id="type"></td>
                            <td id="dates-range"></td>
                            <td id="working-count"></td>
                            <td id="est-date"></td>
                            <td id="failed-count"></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <script>
        $(document).ready(function () {
            $('#tableforecast').DataTable();
        });
    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script>
        function dateToString(date) {
            let month = '' + (date.getMonth() + 1),
                day = '' + date.getDate(),
                year = date.getFullYear();

            if (month.length < 2)
                month = '0' + month;
            if (day.length < 2)
                day = '0' + day;

            return [year, month, day].join('-');
        }

        // Get today's date and the date one year from today
        let today = new Date();
        let nextYear = new Date();
        nextYear.setFullYear(today.getFullYear() + 1);

        // Set default end and forecast dates
        $('#end-date').val(dateToString(today));
        $('#forecast-date').val(dateToString(nextYear));

        // Populate electrolyzer_type dropdown
        $.getJSON("{% url 'get_electrolyzer_types' %}", function (response) {
            let electrolyzerTypeSelect = $('#electrolyzer-type');
            response.forEach(function (electrolyzerType) {
                let option = $('<option>');
                option.val(electrolyzerType.id);
                option.text(electrolyzerType.name);
                electrolyzerTypeSelect.append(option);
            });

            // Set the default electrolyzer type to 1
            electrolyzerTypeSelect.val('1');

            // Initial chart update after the electrolyzer type has been set
            $.getJSON("{% url 'get_buildings' %}", function (response) {
                let buildingSelect = $('#building');
                response.forEach(function (building) {
                    let option = $('<option>');
                    option.val(building.id);
                    option.text(building.name);
                    buildingSelect.append(option);
                });

                // Set the default building to 1
                buildingSelect.val('1');

                // Initial chart update after the electrolyzer type and building have been set
                updateChart();
            });
        });

        function updateChart() {
            let startDate = $('#start-date').val();
            let endDate = $('#end-date').val();
            let forecastDate = $('#forecast-date').val();
            let electrolyzerType = $('#electrolyzer-type').val();
            let building = $('#building').val();

            if (new Date(endDate) <= new Date(startDate) || new Date(forecastDate) <= new Date(endDate)) {
                alert('Неверные даты. Убедитесь, что Дата окончания > Дата начала и Дата прогноза > Дата окончания.');
                return;
            }

            // Use these dates to update the chart
            $.getJSON("{% url 'get_electrolyzer_data' %}", {
                start_date: startDate,
                end_date: endDate,
                forecast_date: forecastDate,
                electrolyzer_type: electrolyzerType,
                building: building
            }, function (response) {
                var weibullX = response.weibull.x;
                var weibullY = response.weibull.y;
                var empiricalX = response.empirical.x;
                var empiricalY = response.empirical.y;

                var trace1 = {
                    x: weibullX,
                    y: weibullY,
                    mode: 'lines',
                    name: response.weibull.name,
                    line: {
                        shape: 'spline'
                    }
                };

                var trace2 = {
                    x: empiricalX,
                    y: empiricalY,
                    mode: 'lines',
                    name: response.empirical.name,
                    line: {
                        shape: 'spline'
                    }
                };

                var data = [trace1, trace2];

                let layout = {
                    title: 'CDF',
                    xaxis: {title: 'Дни'},
                    yaxis: {title: '%'},
                    autosize: true
                };

                document.getElementById("building1").innerText = response.building;
                document.getElementById("type").innerText = response.type;
                document.getElementById("working-count").innerText = response.working_count;
                document.getElementById("failed-count").innerText = response.failed_count;
                Plotly.newPlot('chart', data, layout);
            })
                .fail(function (jqXHR, textStatus, errorThrown) {
                    // Display error message when AJAX call fails
                    alert("Нет данных в выбранном диапазоне дат. Пожалуйста, выберите другой диапазон.");
                });
        }

        $(window).resize(function () {
            Plotly.relayout('chart', {
                'xaxis.autorange': true,
                'yaxis.autorange': true
            });
        });

        // Event handler for update button
        $('#update-chart').click(updateChart);
    </script>
{% endblock %}
